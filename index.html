<!DOCTYPE html>
<html lang="uk" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Student Hub ‚Äî –£–∫—Ä–î–£–ó–¢</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0a0a0f;--bg2:#111118;--bg3:#1a1a24;--border:#2a2a3a;
  --accent:#f0c040;--accent2:#e05050;--text:#e8e8f0;--text2:#8888aa;
  --card:#13131e;--success:#40d080;--warning:#f0a030;--r:12px;
  --sidebar:250px;
}
html { font-size: 16px; }
[data-theme="light"]{--bg:#f4f4f8;--bg2:#fff;--bg3:#ebebf3;--border:#d0d0e0;--text:#1a1a2e;--text2:#606088;--card:#fff;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;transition:background .3s,color .3s;-webkit-tap-highlight-color:transparent;font-size:15px;}
a{text-decoration:none;color:inherit;}

/* ‚ïê‚ïê‚ïê SCREENS ‚ïê‚ïê‚ïê */
.screen{display:none;min-height:100vh;}
.screen.active{display:flex;}

/* ‚ïê‚ïê‚ïê LOGIN / AUTH ‚ïê‚ïê‚ïê */
#screen-login{align-items:center;justify-content:center;background:var(--bg);position:relative;overflow:hidden;}
#screen-login::before{content:'';position:absolute;width:500px;height:500px;background:radial-gradient(circle,rgba(240,192,64,.08) 0%,transparent 70%);top:-150px;right:-150px;pointer-events:none;}
#screen-login::after{content:'';position:absolute;width:350px;height:350px;background:radial-gradient(circle,rgba(224,80,80,.06) 0%,transparent 70%);bottom:-80px;left:-80px;pointer-events:none;}
.auth-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px;width:420px;max-width:calc(100vw - 32px);position:relative;z-index:1;animation:fadeUp .5s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.auth-logo{display:flex;align-items:center;gap:10px;margin-bottom:24px;}
.auth-logo .ico{width:38px;height:38px;background:var(--accent);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.auth-logo h1{font-size:18px;font-weight:800;}
.auth-logo span{color:var(--accent);}
.auth-box h2{font-size:22px;font-weight:800;margin-bottom:4px;}
.auth-box>p{color:var(--text2);font-size:12px;margin-bottom:20px;}
.sep{display:flex;align-items:center;gap:10px;margin:16px 0;font-size:10px;font-weight:700;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;}
.sep::before,.sep::after{content:'';flex:1;height:1px;background:var(--border);}
.field{margin-bottom:11px;}
.field label{display:block;font-size:10px;font-weight:700;color:var(--text2);margin-bottom:4px;letter-spacing:.5px;text-transform:uppercase;}
.field input,.field select{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:11px 13px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;outline:none;transition:border-color .2s;-webkit-appearance:none;}
.field input:focus,.field select:focus{border-color:var(--accent);}
.btn-primary{width:100%;background:var(--accent);color:#0a0a0f;border:none;border-radius:var(--r);padding:13px;font-family:'Syne',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:opacity .2s,transform .1s;margin-top:6px;}
.btn-primary:hover{opacity:.9;transform:translateY(-1px);}
.btn-primary:active{transform:translateY(0);}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.err-box{background:rgba(224,80,80,.1);border:1px solid rgba(224,80,80,.3);border-radius:var(--r);padding:10px 13px;font-size:12px;color:var(--accent2);margin-top:10px;display:none;}
.login-info{font-size:10px;color:var(--text2);text-align:center;margin-top:12px;line-height:1.5;}

/* ‚ïê‚ïê‚ïê APP LAYOUT ‚ïê‚ïê‚ïê */
#screen-app{flex-direction:row;}

/* SIDEBAR */
.sidebar{width:var(--sidebar);min-height:100vh;background:var(--bg2);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;transition:transform .3s ease;}
.sidebar-header{padding:18px 16px;display:flex;align-items:center;gap:9px;border-bottom:1px solid var(--border);}
.sidebar-header .ico{width:30px;height:30px;background:var(--accent);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.sidebar-header h1{font-size:13px;font-weight:800;}
.sidebar-header span{color:var(--accent);}
.close-sidebar{display:none;margin-left:auto;background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;padding:4px;}
.group-pill{padding:5px 16px;background:rgba(240,192,64,.07);border-bottom:1px solid var(--border);font-size:10px;color:var(--accent);font-family:'JetBrains Mono',monospace;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.nav{padding:10px 8px;flex:1;overflow-y:auto;}
.nav-section{font-size:9px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;padding:8px 8px 4px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:10px 10px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;color:var(--text2);transition:all .15s;margin-bottom:1px;user-select:none;}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:rgba(240,192,64,.12);color:var(--accent);}
.nav-item .ni{font-size:14px;width:16px;text-align:center;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--accent2);color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:10px;min-width:16px;text-align:center;}
.sidebar-bottom{padding:10px 8px;border-top:1px solid var(--border);}
.user-card{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;background:var(--bg3);}
.user-avatar{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#0a0a0f;flex-shrink:0;}
.user-info{flex:1;min-width:0;}
.user-name{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-role-badge{font-size:9px;color:var(--text2);}
.icon-btn{background:none;border:none;color:var(--text2);cursor:pointer;font-size:13px;padding:3px;border-radius:5px;transition:color .2s;flex-shrink:0;}
.icon-btn:hover{color:var(--text);}

/* MAIN */
.main{margin-left:var(--sidebar);min-height:100vh;flex:1;display:flex;flex-direction:column;}
.topbar{display:none;padding:12px 16px;background:var(--bg2);border-bottom:1px solid var(--border);align-items:center;gap:10px;position:sticky;top:0;z-index:100;}
.topbar-menu{background:none;border:none;color:var(--text);font-size:20px;cursor:pointer;padding:4px;}
.topbar h2{font-size:15px;font-weight:800;flex:1;}
.content{padding:28px;flex:1;}

/* OVERLAY */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:199;}
.sidebar-overlay.show{display:block;}

/* ‚ïê‚ïê‚ïê PAGES ‚ïê‚ïê‚ïê */
.page{display:none;animation:fadeIn .25s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.page-header{margin-bottom:20px;}
.page-header h2{font-size:26px;font-weight:800;margin-bottom:3px;}
.page-header p{color:var(--text2);font-size:13px;}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:20px;}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px;display:flex;align-items:center;gap:10px;}
.stat-ico{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
.si-y{background:rgba(240,192,64,.15);}
.si-r{background:rgba(224,80,80,.15);}
.si-g{background:rgba(64,208,128,.15);}
.si-b{background:rgba(64,128,240,.15);}
.stat-val{font-size:22px;font-weight:800;font-family:'JetBrains Mono',monospace;line-height:1;}
.stat-lbl{font-size:10px;color:var(--text2);margin-top:2px;}

/* DEADLINE */
.dl-list{display:flex;flex-direction:column;gap:6px;}
.dl-item{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:11px 14px;display:flex;align-items:center;gap:10px;transition:border-color .2s,background .2s;}
.dl-item.click{cursor:pointer;}
.dl-item.click:hover{border-color:var(--accent);background:var(--bg3);}
.dl-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.dot-u{background:var(--accent2);box-shadow:0 0 5px rgba(224,80,80,.5);}
.dot-s{background:var(--warning);}
.dot-o{background:var(--success);}
.dl-info{flex:1;min-width:0;}
.dl-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.dl-course{font-size:11px;color:var(--text2);}
.dl-right{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.dl-date{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text2);}
.dl-date.u{color:var(--accent2);}
.dl-date.s{color:var(--warning);}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:7px;margin-bottom:14px;flex-wrap:wrap;}
.tb-input{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:8px 12px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;outline:none;flex:1;min-width:140px;max-width:220px;transition:border-color .2s;}
.tb-input:focus{border-color:var(--accent);}
.tb-select{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:7px 10px;color:var(--text);font-family:'Syne',sans-serif;font-size:11px;outline:none;-webkit-appearance:none;}
.tb-right{margin-left:auto;display:flex;gap:5px;align-items:center;}
.section-title{font-size:9px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin:18px 0 8px;}

/* FILES */
.upload-zone{border:2px dashed var(--border);border-radius:var(--r);padding:22px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s;margin-bottom:14px;}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:rgba(240,192,64,.03);}
.upload-zone .ui{font-size:24px;margin-bottom:6px;}
.upload-zone p{font-size:12px;color:var(--text2);}
.upload-zone strong{color:var(--accent);}
#file-input{display:none;}
.file-list{display:flex;flex-direction:column;gap:6px;}
.file-item{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:10px 13px;display:flex;align-items:center;gap:10px;}
.file-ext{width:32px;height:32px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:700;font-family:'JetBrains Mono',monospace;flex-shrink:0;}
.ep{background:rgba(224,80,80,.15);color:var(--accent2);}
.ed{background:rgba(64,128,240,.15);color:#4080f0;}
.ex{background:rgba(64,192,80,.15);color:#40c050;}
.eo{background:var(--bg3);color:var(--text2);}
.file-info{flex:1;min-width:0;}
.file-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.file-meta{font-size:11px;color:var(--text2);margin-top:1px;}
.file-actions{display:flex;gap:4px;flex-shrink:0;}

/* BUTTONS */
.btn{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:5px 10px;font-size:11px;font-weight:600;color:var(--text2);cursor:pointer;transition:all .15s;font-family:'Syne',sans-serif;white-space:nowrap;}
.btn:hover{border-color:var(--accent);color:var(--accent);}
.btn.a{background:var(--accent);border-color:var(--accent);color:#0a0a0f;}
.btn.a:hover{opacity:.85;color:#0a0a0f;}
.btn.d:hover{border-color:var(--accent2);color:var(--accent2);}
.btn.r{background:rgba(224,80,80,.1);border-color:rgba(224,80,80,.3);color:var(--accent2);}

/* COURSES */
.course-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;}
.course-grid.lv{grid-template-columns:1fr;}
.course-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:15px;cursor:pointer;transition:border-color .2s,transform .15s;display:block;color:var(--text);}
.course-card:hover{border-color:var(--accent);transform:translateY(-2px);}
.lv .course-card{display:flex;align-items:center;gap:11px;padding:10px 13px;}
.lv .course-card:hover{transform:none;}
.c-num{font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--accent);font-weight:500;margin-bottom:4px;flex-shrink:0;}
.lv .c-num{margin-bottom:0;}
.c-name{font-size:12px;font-weight:700;line-height:1.3;flex:1;}
.c-meta{font-size:10px;color:var(--text2);margin-top:2px;}
.lv .c-meta{display:none;}
.ftab{padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;transition:all .15s;font-family:'Syne',sans-serif;}
.ftab:hover{border-color:var(--accent);color:var(--accent);}
.ftab.on{background:var(--accent);border-color:var(--accent);color:#0a0a0f;}
.vbtn{width:26px;height:26px;border-radius:5px;border:1px solid var(--border);background:var(--card);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;transition:all .15s;}
.vbtn.on{background:var(--accent);border-color:var(--accent);color:#0a0a0f;}

/* CHAT */
.chat-wrap{display:flex;gap:14px;height:calc(100vh - 180px);min-height:300px;}
.chat-sidebar{width:200px;flex-shrink:0;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}
.chat-room{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:10px 12px;cursor:pointer;transition:border-color .2s;font-size:12px;font-weight:600;}
.chat-room:hover{border-color:var(--accent);}
.chat-room.active{border-color:var(--accent);background:rgba(240,192,64,.07);}
.chat-room-sub{font-size:10px;color:var(--text2);font-weight:400;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-main{flex:1;display:flex;flex-direction:column;background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.chat-header{padding:12px 14px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;}
.chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;}
.msg{max-width:75%;display:flex;flex-direction:column;gap:2px;}
.msg.me{align-self:flex-end;align-items:flex-end;}
.msg.other{align-self:flex-start;}
.msg-author{font-size:9px;color:var(--text2);font-weight:600;margin-bottom:1px;}
.msg-bubble{background:var(--bg3);border-radius:10px;padding:8px 11px;font-size:12px;line-height:1.4;word-break:break-word;}
.msg.me .msg-bubble{background:rgba(240,192,64,.15);border-radius:10px 10px 2px 10px;}
.msg.other .msg-bubble{border-radius:10px 10px 10px 2px;}
.msg-time{font-size:9px;color:var(--text2);font-family:'JetBrains Mono',monospace;}
.chat-input-wrap{padding:10px;border-top:1px solid var(--border);display:flex;gap:7px;}
.chat-input{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:9px 12px;color:var(--text);font-family:'Syne',sans-serif;font-size:12px;outline:none;resize:none;}
.chat-input:focus{border-color:var(--accent);}

/* ADMIN */
.admin-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px;}
.admin-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px;}
.admin-card h3{font-size:14px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.group-item{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;}
.group-item:last-child{border-bottom:none;}
.group-item .gname{flex:1;font-weight:600;word-break:break-word;line-height:1.3;}
.group-item .gcnt{font-size:10px;color:var(--text2);word-break:break-word;margin-top:2px;}
.group-item>div:first-child{flex:1;min-width:0;}
.user-row{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px;}
.user-row:last-child{border-bottom:none;}
.user-row .uav{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#0a0a0f;flex-shrink:0;}
.user-row .uname{flex:1;font-weight:600;}
.role-sel{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:3px 7px;color:var(--text);font-family:'Syne',sans-serif;font-size:10px;outline:none;}

/* TAGS */
.tag{display:inline-block;padding:2px 6px;border-radius:20px;font-size:9px;font-weight:600;background:var(--bg3);color:var(--text2);border:1px solid var(--border);}
.tag.g{background:rgba(64,208,128,.12);color:var(--success);border-color:rgba(64,208,128,.2);}
.tag.y{background:rgba(240,192,64,.12);color:var(--accent);border-color:rgba(240,192,64,.2);}
.tag.r{background:rgba(224,80,80,.12);color:var(--accent2);border-color:rgba(224,80,80,.2);}

/* SYNC BADGE */
.sync-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(64,208,128,.1);border:1px solid rgba(64,208,128,.2);border-radius:20px;padding:3px 9px;font-size:10px;color:var(--success);font-weight:600;}
.sync-dot{width:5px;height:5px;background:var(--success);border-radius:50%;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* STATES */
.loading{display:flex;align-items:center;gap:8px;color:var(--text2);font-size:12px;padding:16px 0;}
.spinner{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:32px 16px;color:var(--text2);}
.empty .emo{font-size:28px;margin-bottom:8px;}
.empty p{font-size:12px;}

/* MODAL */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:999;padding:16px;}
.modal-ov.show{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;width:420px;max-width:100%;animation:fadeUp .25s ease;}
.modal h3{font-size:16px;font-weight:800;margin-bottom:16px;}
.modal-actions{display:flex;gap:7px;justify-content:flex-end;margin-top:16px;}

/* ‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê */
@media(max-width:768px){
  :root{--sidebar:0px;}
  .sidebar{transform:translateX(-240px);width:240px;}
  .sidebar.open{transform:translateX(0);}
  .main{margin-left:0;}
  .topbar{display:flex;}
  .close-sidebar{display:block;}
  .content{padding:14px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:8px;}
  .stat-card{padding:11px;}
  .stat-val{font-size:18px;}
  .chat-wrap{flex-direction:column;height:auto;}
  .chat-sidebar{width:100%;flex-direction:row;overflow-x:auto;overflow-y:visible;padding-bottom:2px;}
  .chat-room{min-width:120px;flex-shrink:0;}
  .chat-main{height:400px;}
  .admin-grid{grid-template-columns:1fr;}
  .auth-box{padding:28px 22px;}
  .toolbar{gap:5px;}
  .tb-input{min-width:120px;}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:1fr 1fr;}
  .dl-date{display:none;}
  .course-grid{grid-template-columns:1fr;}
  .page-header h2{font-size:18px;}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
<div id="screen-login" class="screen active">
  <div class="auth-box">
    <div class="auth-logo">
      <div class="ico">üéì</div>
      <h1>Student<span>Hub</span></h1>
    </div>
    <h2>–í—Ö—ñ–¥</h2>
    <p>–ü–æ—Ä—Ç–∞–ª —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤ –£–∫—Ä–î–£–ó–¢</p>
    <div class="field"><label>–õ–æ–≥—ñ–Ω –≤—ñ–¥ Moodle</label><input type="text" id="li" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="username"></div>
    <div class="field"><label>–ü–∞—Ä–æ–ª—å –≤—ñ–¥ Moodle</label><input type="password" id="lp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
    <div class="sep">–í–∞—à–∞ –≥—Ä—É–ø–∞</div>
    <div class="field">
      <label>–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É</label>
      <select id="lg"><option value="">‚Äî –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä—É–ø... ‚Äî</option></select>
    </div>
    <button class="btn-primary" id="login-btn" onclick="doLogin()">–£–≤—ñ–π—Ç–∏</button>
    <div class="err-box" id="lerr"></div>
    <p class="login-info">–õ–æ–≥—ñ–Ω/–ø–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä –£–∫—Ä–î–£–ó–¢</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê -->
<div id="screen-app" class="screen">
  <div class="sidebar-overlay" id="sov" onclick="closeSidebar()"></div>

  <!-- SIDEBAR -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="ico">üéì</div>
      <h1>Student<span>Hub</span></h1>
      <button class="close-sidebar" onclick="closeSidebar()">‚úï</button>
    </div>
    <div class="group-pill" id="gpill">–ì—Ä—É–ø–∞: ‚Äî</div>
    <div class="nav" id="nav">
      <div class="nav-section">–ù–∞–≤—á–∞–Ω–Ω—è</div>
      <div class="nav-item active" onclick="go('dashboard')"><span class="ni">üè†</span>–ì–æ–ª–æ–≤–Ω–∞</div>
      <div class="nav-item" onclick="go('deadlines')"><span class="ni">‚è∞</span>–î–µ–¥–ª–∞–π–Ω–∏</div>
      <div class="nav-item" onclick="go('courses')"><span class="ni">üìö</span>–ö—É—Ä—Å–∏</div>
      <div class="nav-section">–ì—Ä—É–ø–∞</div>
      <div class="nav-item" onclick="go('files')"><span class="ni">üìÅ</span>–§–∞–π–ª–∏</div>
      <div class="nav-item" onclick="go('materials')"><span class="ni">üìù</span>–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏</div>
      <div class="nav-item" onclick="go('chat')"><span class="ni">üí¨</span>–ß–∞—Ç–∏<span class="nav-badge" id="chat-badge" style="display:none">0</span></div>
      <div class="nav-section" id="admin-section" style="display:none">–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è</div>
      <div class="nav-item" id="nav-admin" onclick="go('admin')" style="display:none"><span class="ni">‚öôÔ∏è</span>–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</div>
    </div>
    <div class="sidebar-bottom">
      <div class="user-card">
        <div class="user-avatar" id="uav" style="background:var(--accent)">?</div>
        <div class="user-info">
          <div class="user-name" id="uname">...</div>
          <div class="user-role-badge" id="urole">–°—Ç—É–¥–µ–Ω—Ç</div>
        </div>
        <button class="icon-btn" onclick="toggleTheme()">üåì</button>
        <button class="icon-btn" onclick="doLogout()">‚Ü©</button>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR (mobile) -->
    <div class="topbar" id="topbar">
      <button class="topbar-menu" onclick="openSidebar()">‚ò∞</button>
      <h2 id="topbar-title">–ì–æ–ª–æ–≤–Ω–∞</h2>
      <button class="icon-btn" onclick="toggleTheme()">üåì</button>
    </div>

    <div class="content">
      <!-- DASHBOARD -->
      <div class="page active" id="page-dashboard">
        <div class="page-header">
          <h2>–î–æ–±—Ä–∏–π –¥–µ–Ω—å! üëã</h2>
          <p id="dash-sub">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>
        </div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
          <div class="sync-badge"><div class="sync-dot"></div>Moodle</div>
          <button class="btn" onclick="syncMoodle()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-ico si-y">üìö</div><div><div class="stat-val" id="s-courses">‚Äî</div><div class="stat-lbl">–ö—É—Ä—Å—ñ–≤</div></div></div>
          <div class="stat-card"><div class="stat-ico si-r">‚è∞</div><div><div class="stat-val" id="s-urgent">‚Äî</div><div class="stat-lbl">–¢–µ—Ä–º—ñ–Ω–æ–≤–æ</div></div></div>
          <div class="stat-card"><div class="stat-ico si-g">‚úÖ</div><div><div class="stat-val" id="s-done">‚Äî</div><div class="stat-lbl">–ú–∏–Ω—É–ª–æ</div></div></div>
          <div class="stat-card"><div class="stat-ico si-b">üìÅ</div><div><div class="stat-val" id="s-files">‚Äî</div><div class="stat-lbl">–§–∞–π–ª—ñ–≤</div></div></div>
        </div>
        <div class="section-title">–ù–∞–π–±–ª–∏–∂—á—ñ –¥–µ–¥–ª–∞–π–Ω–∏</div>
        <div id="dash-dl"><div class="loading"><div class="spinner"></div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
      </div>

      <!-- DEADLINES -->
      <div class="page" id="page-deadlines">
        <div class="page-header"><h2>‚è∞ –î–µ–¥–ª–∞–π–Ω–∏</h2><p>–ó Moodle ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</p></div>
        <div class="toolbar">
          <input class="tb-input" id="dl-q" placeholder="üîç –ü–æ—à—É–∫..." oninput="applyDlFilter()">
          <select class="tb-select" id="dl-f" onchange="applyDlFilter()">
            <option value="all">–í—Å—ñ</option>
            <option value="active">–ê–∫—Ç–∏–≤–Ω—ñ</option>
            <option value="urgent">–¢–µ—Ä–º—ñ–Ω–æ–≤—ñ</option>
            <option value="past">–ú–∏–Ω—É–ª—ñ</option>
          </select>
          <div class="tb-right"><button class="btn a" onclick="syncMoodle()">üîÑ</button></div>
        </div>
        <div id="dl-list"><div class="loading"><div class="spinner"></div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
      </div>

      <!-- COURSES -->
      <div class="page" id="page-courses">
        <div class="page-header"><h2>üìö –ö—É—Ä—Å–∏</h2><p>–ó Moodle ‚Äî –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏</p></div>
        <div class="toolbar">
          <input class="tb-input" id="c-q" placeholder="üîç –ü–æ—à—É–∫ –∫—É—Ä—Å—É..." oninput="filterCourses()">
          <button class="ftab on" id="cs-n" onclick="setCS('name')">–ê-–Ø</button>
          <button class="ftab" id="cs-num" onclick="setCS('num')">#</button>
          <div class="tb-right" style="display:flex;gap:4px;">
            <button class="vbtn on" id="vg" onclick="setCV('grid')" title="–ö–∞—Ä—Ç–∫–∏">‚äû</button>
            <button class="vbtn" id="vl" onclick="setCV('list')" title="–°–ø–∏—Å–æ–∫">‚ò∞</button>
          </div>
        </div>
        <div id="courses-list"><div class="loading"><div class="spinner"></div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
      </div>

      <!-- FILES -->
      <div class="page" id="page-files">
        <div class="page-header"><h2>üìÅ –§–∞–π–ª–∏ –≥—Ä—É–ø–∏</h2><p id="files-lbl">–°–ø—ñ–ª—å–Ω—ñ —Ñ–∞–π–ª–∏ –≤–∞—à–æ—ó –≥—Ä—É–ø–∏</p></div>
        <div class="upload-zone" id="uz" onclick="document.getElementById('file-input').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event)">
          <div class="ui">üì§</div>
          <p><strong>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å</strong></p>
          <p style="font-size:10px;margin-top:2px;">–¥–æ 700–ö–ë ‚Ä¢ –±—ñ–ª—å—à—ñ —Ñ–∞–π–ª–∏ ‚Äî —á–µ—Ä–µ–∑ Google Drive —É –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏</p>
        </div>
        <input type="file" id="file-input" multiple onchange="handleFileSelect(this)">
        <div class="section-title">–§–∞–π–ª–∏</div>
        <div id="files-list"><div class="loading"><div class="spinner"></div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
      </div>

      <!-- MATERIALS -->
      <div class="page" id="page-materials">
        <div class="page-header"><h2>üìù –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏</h2><p id="mats-lbl">–ö–æ–Ω—Å–ø–µ–∫—Ç–∏ —Ç–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –≥—Ä—É–ø–∏</p></div>
        <div class="toolbar">
          <input class="tb-input" placeholder="üîç –ü–æ—à—É–∫..." oninput="filterMats(this.value)">
          <div class="tb-right"><button class="btn a" onclick="showModal('add-mat')">+ –î–æ–¥–∞—Ç–∏</button></div>
        </div>
        <div id="mats-list"><div class="loading"><div class="spinner"></div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div></div>
      </div>

      <!-- CHAT -->
      <div class="page" id="page-chat">
        <div class="page-header"><h2>üí¨ –ß–∞—Ç–∏</h2><p>–°–ø—ñ–ª–∫—É–π—Ç–µ—Å—å –∑ –≥—Ä—É–ø–æ—é —Ç–∞ —É–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç–æ–º</p></div>
        <div class="chat-wrap">
          <div class="chat-sidebar" id="chat-rooms"></div>
          <div class="chat-main">
            <div class="chat-header" id="chat-room-title">–û–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É</div>
            <div class="chat-messages" id="chat-msgs"><div class="empty"><div class="emo">üí¨</div><p>–û–±–µ—Ä—ñ—Ç—å —á–∞—Ç –∑–ª—ñ–≤–∞</p></div></div>
            <div class="chat-input-wrap">
              <textarea class="chat-input" id="chat-inp" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1" onkeydown="chatKey(event)"></textarea>
              <button class="btn a" onclick="sendMsg()">‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div class="page" id="page-admin">
        <div class="page-header"><h2>‚öôÔ∏è –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å</h2><p>–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≥—Ä—É–ø–∞–º–∏ —Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏</p></div>
        <div class="admin-grid">
          <!-- Groups -->
          <div class="admin-card">
            <h3>üè´ –ì—Ä—É–ø–∏</h3>
            <div id="admin-groups-list"><div class="loading"><div class="spinner"></div></div></div>
            <button class="btn a" style="width:100%;margin-top:10px;" onclick="showModal('add-group')">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É–ø—É</button>
          </div>
          <!-- Users -->
          <div class="admin-card">
            <h3>üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h3>
            <input class="tb-input" id="users-search" placeholder="üîç –ü–æ—à—É–∫ –ø–æ —ñ–º–µ–Ω—ñ..." oninput="filterAdminUsers(this.value)" style="width:100%;margin-bottom:10px;max-width:100%;">
            <div id="admin-users-list"><div class="loading"><div class="spinner"></div></div></div>
          </div>
          <!-- Stats -->
          <div class="admin-card">
            <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
            <div id="admin-stats"><div class="loading"><div class="spinner"></div></div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-ov" id="modal-add-mat">
  <div class="modal">
    <h3>üìù –î–æ–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª</h3>
    <div class="field"><label>–ù–∞–∑–≤–∞</label><input type="text" id="mn" placeholder="–ö–æ–Ω—Å–ø–µ–∫—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏—Ü—ñ"></div>
    <div class="field"><label>–ü—Ä–µ–¥–º–µ—Ç</label><input type="text" id="ms" placeholder="–í–∏—â–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞"></div>
    <div class="field"><label>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –∞–±–æ –æ–ø–∏—Å</label><input type="text" id="md" placeholder="https://drive.google.com/..."></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('add-mat')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn a" onclick="addMat()">–î–æ–¥–∞—Ç–∏</button>
    </div>
  </div>
</div>

<div class="modal-ov" id="modal-add-group">
  <div class="modal">
    <h3>üè´ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É–ø—É</h3>
    <div class="field"><label>–ù–∞–∑–≤–∞ –≥—Ä—É–ø–∏</label><input type="text" id="gn" placeholder="103-–û–ü–£–¢-–î24"></div>
    <div class="field"><label>–§–∞–∫—É–ª—å—Ç–µ—Ç</label><input type="text" id="gf" placeholder="–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó"></div>
    <div class="field">
      <label>–ö—É—Ä—Å (1-4 –∞–≤—Ç–æ, 5-6 –≤—Ä—É—á–Ω—É)</label>
      <input type="number" id="gc" placeholder="1" min="1" max="6">
      <div id="gc-hint" style="font-size:9px;color:var(--text2);margin-top:3px;"></div>
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal('add-group')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn a" id="group-modal-btn" onclick="groupModalAction()">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import { getFirestore, collection, addDoc, deleteDoc, doc, query, where, orderBy, onSnapshot, getDocs, setDoc, getDoc, updateDoc, serverTimestamp, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const cfg = {
  apiKey:"AIzaSyAXscEMkW51sejM_yBkMcL_QyvgfAWT7sE",
  authDomain:"student-hub-ukrdust.firebaseapp.com",
  projectId:"student-hub-ukrdust",
  storageBucket:"student-hub-ukrdust.firebasestorage.app",
  messagingSenderId:"181184327168",
  appId:"1:181184327168:web:3ceca4b24980f900eff2e5"
};
const app = initializeApp(cfg);
const db = getFirestore(app);
window._db = db;
window._fb = { collection, addDoc, deleteDoc, doc, query, where, orderBy, onSnapshot, getDocs, setDoc, getDoc, updateDoc, serverTimestamp, limit };

// Load groups into login select
async function loadGroupsForLogin() {
  const sel = document.getElementById('lg');
  try {
    const snap = await getDocs(collection(db, 'groups'));
    const groups = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (a.name||'').localeCompare(b.name||''));
    if (!groups.length) {
      sel.innerHTML = '<option value="">‚Äî –ì—Ä—É–ø —â–µ –Ω–µ–º–∞—î (–∑–≤–µ—Ä–Ω—ñ—Ç—å—Å—è –¥–æ –∞–¥–º—ñ–Ω–∞) ‚Äî</option>';
      return;
    }
    // Group by faculty
    const faculties = {};
    groups.forEach(g => {
      const f = g.faculty || '–Ü–Ω—à—ñ';
      if (!faculties[f]) faculties[f] = [];
      faculties[f].push(g);
    });
    let html = '<option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É ‚Äî</option>';
    Object.keys(faculties).sort().forEach(f => {
      html += '<optgroup label="' + f + '">';
      faculties[f].forEach(g => { html += '<option value="' + g.id + '">' + g.name + '</option>'; });
      html += '</optgroup>';
    });
    sel.innerHTML = html;
  } catch(e) {
    sel.innerHTML = '<option value="">‚Äî –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ‚Äî</option>';
  }
}
loadGroupsForLogin();

window._loadGroupsForLogin = loadGroupsForLogin;
</script>

<script>
const MOODLE = 'https://do.kart.edu.ua';
let token='', userData={}, allDl=[], courses=[], group={}, userRole='student';
let unsubs=[], cachedFiles=[], cachedMats=[], currentChatRoom=null, chatUnsub=null;
let cvMode='grid', csMode='name';

// ‚îÄ‚îÄ XSS PROTECTION ‚îÄ‚îÄ
function escHtml(t) { return (t==null?'':String(t)).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

// ‚îÄ‚îÄ COURSE CALC ‚îÄ‚îÄ
function calcCourse(entryYear) {
  const now = new Date();
  const acadYear = now.getMonth() >= 7 ? now.getFullYear() : now.getFullYear() - 1;
  return Math.min(Math.max(acadYear - entryYear + 1, 1), 6);
}
function getGroupCourse(g) {
  if(g.manualCourse) return g.manualCourse;
  if(g.entryYear) return calcCourse(g.entryYear);
  return g.course || '?';
}

// ‚îÄ‚îÄ ROLES ‚îÄ‚îÄ
const ROLES = { superadmin:'üî¥ –°—É–ø–µ—Ä-–∞–¥–º—ñ–Ω', admin:'üü† –ê–¥–º—ñ–Ω', moderator:'üü° –ú–æ–¥–µ—Ä–∞—Ç–æ—Ä', student:'üü¢ –°—Ç—É–¥–µ–Ω—Ç' };
const ROLE_COLORS = { superadmin:'#e05050', admin:'#f0a030', moderator:'#f0c040', student:'#40d080' };
function canAdmin() { return ['superadmin','admin'].includes(userRole); }
function canMod() { return ['superadmin','admin','moderator'].includes(userRole); }

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function doLogin() {
  const username = document.getElementById('li').value.trim();
  const password = document.getElementById('lp').value;
  const groupId = document.getElementById('lg').value;
  const btn = document.getElementById('login-btn');
  const err = document.getElementById('lerr');
  err.style.display='none';
  if (!username||!password) { showErr('–í–≤–µ–¥—ñ—Ç—å –ª–æ–≥—ñ–Ω —Ç–∞ –ø–∞—Ä–æ–ª—å'); return; }
  if (!groupId) { showErr('–û–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É'); return; }
  btn.disabled=true; btn.textContent='–í—Ö–æ–¥–∏–º–æ...';
  try {
    const r = await fetch(MOODLE+'/login/token.php?username='+encodeURIComponent(username)+'&password='+encodeURIComponent(password)+'&service=moodle_mobile_app');
    const d = await r.json();
    if (d.token) {
      token = d.token;
      // Check if user is a teacher (block teacher accounts)
      try {
        const siteR = await fetch(MOODLE+'/webservice/rest/server.php?wstoken='+d.token+'&wsfunction=core_webservice_get_site_info&moodlewsrestformat=json');
        const siteData = await siteR.json();
        // Moodle returns 'roles' array for site-level roles
        const roles = Array.isArray(siteData.roles) ? siteData.roles : [];
        const teacherShortnames = ['teacher','editingteacher','coursecreator','manager'];
        const isTeacher = roles.some(r => 
          teacherShortnames.includes((r.shortname||'').toLowerCase()) ||
          [1,2,3,4].includes(Number(r.roleid))
        );
        if (isTeacher) {
          token = '';
          showErr('–¶–µ–π –ø–æ—Ä—Ç–∞–ª –ª–∏—à–µ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤. –í–∏–∫–ª–∞–¥–∞—á—ñ –Ω–µ –º–æ–∂—É—Ç—å —É–≤—ñ–π—Ç–∏.');
          btn.disabled=false; btn.textContent='–£–≤—ñ–π—Ç–∏';
          return;
        }
      } catch(roleErr) { console.warn('Role check failed, allowing login:', roleErr); }
      // Load group info
      const { doc, getDoc } = window._fb;
      const gSnap = await getDoc(doc(window._db, 'groups', groupId));
      if (!gSnap.exists()) { showErr('–ì—Ä—É–ø—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ'); btn.disabled=false; btn.textContent='–£–≤—ñ–π—Ç–∏'; return; }
      group = { id: groupId, ...gSnap.data() };
      localStorage.setItem('sh_token', token);
      localStorage.setItem('sh_gid', groupId);
      await initApp();
    } else { showErr(d.error || '–ù–µ–≤—ñ—Ä–Ω–∏–π –ª–æ–≥—ñ–Ω –∞–±–æ –ø–∞—Ä–æ–ª—å'); }
  } catch(e) { showErr('–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è'); }
  btn.disabled=false; btn.textContent='–£–≤—ñ–π—Ç–∏';
}
function showErr(msg) { const e=document.getElementById('lerr'); e.textContent=msg; e.style.display='block'; }
document.getElementById('lp').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

async function initApp() {
  document.getElementById('screen-login').classList.remove('active');
  document.getElementById('screen-app').classList.add('active');
  document.getElementById('gpill').textContent = 'üìå ' + group.name;
  document.getElementById('files-lbl').textContent = '–§–∞–π–ª–∏ –≥—Ä—É–ø–∏ ' + group.name;
  document.getElementById('mats-lbl').textContent = '–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏ –≥—Ä—É–ø–∏ ' + group.name;
  await loadUserInfo();
  await loadUserRole();
  setupNav();
  await syncMoodle();
  listenFiles(); listenMats(); setupChatRooms();
  if (canAdmin()) listenAdminData();
}

async function loadUserInfo() {
  try {
    const d = await moodleCall('core_webservice_get_site_info');
    userData = d;
    const name = d.fullname || '–°—Ç—É–¥–µ–Ω—Ç';
    document.getElementById('uname').textContent = name;
    document.getElementById('uav').textContent = name[0].toUpperCase();
    const today = new Date().toLocaleDateString('uk-UA',{weekday:'long',day:'numeric',month:'long'});
    document.getElementById('dash-sub').textContent = today + ' ‚Ä¢ ' + name;
    // Save/update user in Firestore
    if (window._db && userData.userid) {
      const { doc, setDoc } = window._fb;
      await setDoc(doc(window._db,'users',String(userData.userid)), {
        name, groupId: group.id, groupName: group.name,
        moodleId: userData.userid, lastSeen: Date.now()
      }, { merge: true });
    }
  } catch(e) {}
}

async function loadUserRole() {
  if (!window._db || !userData.userid) return;
  const { doc, getDoc } = window._fb;
  try {
    const snap = await getDoc(doc(window._db,'users',String(userData.userid)));
    if (snap.exists() && snap.data().role) {
      userRole = snap.data().role;
    } else { userRole = 'student'; }
  } catch(e) { userRole = 'student'; }
  document.getElementById('urole').textContent = ROLES[userRole] || '–°—Ç—É–¥–µ–Ω—Ç';
  document.getElementById('uav').style.background = ROLE_COLORS[userRole] || '#f0c040';
}

function setupNav() {
  if (canAdmin()) {
    document.getElementById('admin-section').style.display='';
    document.getElementById('nav-admin').style.display='';
  }
}

async function moodleCall(fn, params={}) {
  const p = new URLSearchParams({ wstoken:token, wsfunction:fn, moodlewsrestformat:'json', ...params });
  const r = await fetch(MOODLE+'/webservice/rest/server.php?'+p);
  return r.json();
}

// ‚îÄ‚îÄ SYNC ‚îÄ‚îÄ
async function syncMoodle() { await loadCourses(); await loadDeadlines(); }

// ‚îÄ‚îÄ COURSES ‚îÄ‚îÄ
async function loadCourses() {
  document.getElementById('courses-list').innerHTML='<div class="loading"><div class="spinner"></div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫—É—Ä—Å—ñ–≤...</div>';
  if(!token){ document.getElementById('courses-list').innerHTML='<div class="empty"><div class="emo">‚ö†Ô∏è</div><p>–ù–µ–º–∞—î —Ç–æ–∫–µ–Ω—É. –í–∏–π–¥—ñ—Ç—å —ñ —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.</p></div>'; return; }
  try {
    const info = await moodleCall('core_webservice_get_site_info');
    const d = await moodleCall('core_enrol_get_users_courses',{userid:info.userid});
    courses = Array.isArray(d) ? d : [];
    document.getElementById('s-courses').textContent = courses.length;
    filterCourses();
  } catch(e) { courses=[]; }
}
function setCV(v) { cvMode=v; document.getElementById('vg').classList.toggle('on',v==='grid'); document.getElementById('vl').classList.toggle('on',v==='list'); filterCourses(); }
function setCS(s) { csMode=s; document.getElementById('cs-n').classList.toggle('on',s==='name'); document.getElementById('cs-num').classList.toggle('on',s==='num'); filterCourses(); }
function filterCourses() {
  const q=(document.getElementById('c-q')||{value:''}).value.toLowerCase();
  let list=courses.filter(c=>!q||(c.fullname||c.shortname||'').toLowerCase().includes(q));
  if(csMode==='name') list=list.slice().sort((a,b)=>(a.fullname||a.shortname).localeCompare(b.fullname||b.shortname));
  const el=document.getElementById('courses-list');
  if(!list.length){el.innerHTML='<div class="empty"><div class="emo">üìö</div><p>–ö—É—Ä—Å–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p></div>';return;}
  const cls=cvMode==='list'?'course-grid lv':'course-grid';
  el.innerHTML='<div class="'+cls+'">'+list.map((c,i)=>
    '<a class="course-card" href="https://do.kart.edu.ua/course/view.php?id='+encodeURIComponent(c.id)+'" target="_blank" rel="noopener noreferrer">'+
    '<div class="c-num">‚Ññ'+(i+1)+'</div>'+
    '<div class="c-name">'+escHtml(c.fullname||c.shortname)+'</div>'+
    '<div class="c-meta">'+escHtml(c.shortname||'')+'</div></a>'
  ).join('')+'</div>';
}

// ‚îÄ‚îÄ DEADLINES ‚îÄ‚îÄ
async function loadDeadlines() {
  const now=Math.floor(Date.now()/1000);
  document.getElementById('dl-list').innerHTML='<div class="loading"><div class="spinner"></div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ Moodle...</div>';
  document.getElementById('dash-dl').innerHTML='<div class="loading"><div class="spinner"></div>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  if(!token){ 
    document.getElementById('dl-list').innerHTML='<div class="empty"><div class="emo">‚ö†Ô∏è</div><p>–ù–µ–º–∞—î —Ç–æ–∫–µ–Ω—É Moodle. –í–∏–π–¥—ñ—Ç—å —ñ —É–≤—ñ–π–¥—ñ—Ç—å –∑–Ω–æ–≤—É.</p></div>';
    document.getElementById('dash-dl').innerHTML='<div class="empty"><div class="emo">‚ö†Ô∏è</div><p>–ù–µ–º–∞—î —Ç–æ–∫–µ–Ω—É</p></div>';
    return; 
  }
  try {
    let events = [];
    
    // Method 1: Action events by timesort ‚Äî –±–µ–∑ limitcourse —â–æ–± –Ω–µ –±–ª–æ–∫—É–≤–∞—Ç–∏
    try {
      const d1 = await moodleCall('core_calendar_get_action_events_by_timesort',{
        timesortfrom: now - 60*60*24*60,
        timesortto: now + 60*60*24*120,
        limitnum: 200
      });
      console.log('Method 1 raw:', JSON.stringify(d1).slice(0,200));
      if(d1 && !d1.errorcode) {
        const evts = d1.events || d1.data?.events || [];
        if(evts.length) { events = evts; console.log('Method 1:', evts.length); }
      }
    } catch(e1) { console.warn('Method 1 failed:', e1); }
    
    // Method 2: Upcoming view
    if(!events.length) {
      try {
        const d2 = await moodleCall('core_calendar_get_upcoming_view');
        console.log('Method 2 raw:', JSON.stringify(d2).slice(0,200));
        if(d2 && !d2.errorcode) {
          const evts = d2.events || [];
          if(evts.length) { events = evts; console.log('Method 2:', evts.length); }
        }
      } catch(e2) { console.warn('Method 2 failed:', e2); }
    }

    // Method 3: –ü–æ –∫–æ–∂–Ω–æ–º—É –∫—É—Ä—Å—É –æ–∫—Ä–µ–º–æ
    if(!events.length && courses.length) {
      try {
        const fetches = courses.slice(0,15).map(c =>
          moodleCall('core_calendar_get_action_events_by_course',{
            courseid: c.id,
            timesortfrom: now - 60*60*24*30,
            timesortto: now + 60*60*24*120,
            limitnum: 50
          }).catch(()=>null)
        );
        const results = await Promise.all(fetches);
        results.forEach(r => {
          if(r && !r.errorcode && r.events && r.events.length) events = events.concat(r.events);
        });
        const seen = new Set();
        events = events.filter(e => { if(seen.has(e.id)){return false;} seen.add(e.id); return true; });
        console.log('Method 3:', events.length);
      } catch(e3) { console.warn('Method 3 failed:', e3); }
    }

    // Method 4: mod_assign ‚Äî –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è –∑ –¥–µ–¥–ª–∞–π–Ω–∞–º–∏ –Ω–∞–ø—Ä—è–º—É
    if(!events.length && courses.length) {
      try {
        const courseids = courses.slice(0,20).map((c,i)=>`courseids[${i}]=${c.id}`).join('&');
        const r4 = await fetch(MOODLE+'/webservice/rest/server.php?wstoken='+token+'&wsfunction=mod_assign_get_assignments&moodlewsrestformat=json&'+courseids);
        const d4 = await r4.json();
        console.log('Method 4 raw:', JSON.stringify(d4).slice(0,200));
        if(d4 && d4.courses) {
          d4.courses.forEach(course => {
            (course.assignments||[]).forEach(a => {
              if(a.duedate && a.duedate > 0) {
                events.push({
                  id: a.id,
                  name: a.name,
                  course: { fullname: course.fullname },
                  timesort: a.duedate,
                  url: MOODLE+'/mod/assign/view.php?id='+a.cmid
                });
              }
            });
          });
        }
        console.log('Method 4:', events.length);
      } catch(e4) { console.warn('Method 4 failed:', e4); }
    }
    
    console.log('Total events found:', events.length);
    
    allDl = events.filter(e => {
      const t = e.timesort || e.timestart || e.timefinish || 0;
      return t > 0;
    }).map(e => {
      const due = e.timesort || e.timestart || e.timefinish;
      const courseName = e.course ? (e.course.fullname || e.course.shortname || '‚Äî') : 
                        (e.coursename || (e.courseid ? '–ö—É—Ä—Å '+e.courseid : '‚Äî'));
      return {
        id: e.id,
        name: e.name || e.activityname || '–ó–∞–≤–¥–∞–Ω–Ω—è',
        course: courseName,
        due: due,
        past: due < now,
        url: e.url || e.activityurl || '#'
      };
    }).sort((a,b) => a.due - b.due);
    
    const urgent = allDl.filter(d=>!d.past&&(d.due-now)<60*60*48).length;
    const past = allDl.filter(d=>d.past).length;
    document.getElementById('s-urgent').textContent = urgent;
    document.getElementById('s-done').textContent = past;
    applyDlFilter();
    renderDashDl();
    
  } catch(e) {
    console.error('Deadlines error:', e);
    const msg = e && e.message ? e.message : String(e);
    document.getElementById('dl-list').innerHTML='<div class="empty"><div class="emo">‚ö†Ô∏è</div><p>–ü–æ–º–∏–ª–∫–∞ –¥–µ–¥–ª–∞–π–Ω—ñ–≤: ' + escHtml(msg) + '</p></div>';
    document.getElementById('dash-dl').innerHTML='<div class="empty"><div class="emo">‚ö†Ô∏è</div><p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–µ–¥–ª–∞–π–Ω—ñ–≤</p></div>';
    document.getElementById('s-urgent').textContent='!';
    document.getElementById('s-done').textContent='!';
  }
}

function dlDot(d) { if(d.past)return'dot-u'; const diff=d.due-Date.now()/1000; if(diff<60*60*48)return'dot-u'; if(diff<60*60*24*7)return'dot-s'; return'dot-o'; }
function dlDateCls(d) { if(d.past)return'u'; const diff=d.due-Date.now()/1000; if(diff<60*60*48)return'u'; if(diff<60*60*24*7)return's'; return''; }
function fmtDate(ts) { return new Date(ts*1000).toLocaleDateString('uk-UA',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}); }

function applyDlFilter() {
  const q=(document.getElementById('dl-q')||{value:''}).value.toLowerCase();
  const f=(document.getElementById('dl-f')||{value:'all'}).value;
  const now=Date.now()/1000;
  let list=allDl.filter(d=>!q||d.name.toLowerCase().includes(q)||d.course.toLowerCase().includes(q));
  if(f==='active') list=list.filter(d=>!d.past);
  else if(f==='urgent') list=list.filter(d=>!d.past&&(d.due-now)<60*60*48);
  else if(f==='past') list=list.filter(d=>d.past);
  renderDl(list, document.getElementById('dl-list'));
}

function renderDl(list, el) {
  if(!list.length){el.innerHTML='<div class="empty"><div class="emo">üéâ</div><p>–î–µ–¥–ª–∞–π–Ω—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p></div>';return;}
  el.innerHTML='<div class="dl-list">'+list.map(d=>{
    const dc=dlDot(d), dtc=dlDateCls(d);
    const hasUrl=d.url&&d.url!=='#';
    return '<div class="dl-item'+(hasUrl?' click':'')+(d.past?' opacity' :'')+'"'+
      (hasUrl?' onclick="window.open(this.dataset.url)" data-url="'+escHtml(d.url)+'"':'')+(d.past?' style="opacity:.6"':'')+'>'+
      '<div class="dl-dot '+dc+'"></div>'+
      '<div class="dl-info"><div class="dl-name">'+escHtml(d.name)+(hasUrl?' <span style="opacity:.4;font-size:9px">‚Üó</span>':'')+'</div>'+
      '<div class="dl-course">'+escHtml(d.course)+'</div></div>'+
      '<div class="dl-right">'+
        '<div class="dl-date '+dtc+'">'+fmtDate(d.due)+'</div>'+
        (d.past?'<span class="tag">–ú–∏–Ω—É–≤</span>':'')+
      '</div></div>';
  }).join('')+'</div>';
}

function renderDashDl() {
  const el=document.getElementById('dash-dl');
  const top=allDl.filter(d=>!d.past).slice(0,5);
  if(!top.length){el.innerHTML='<div class="empty"><div class="emo">üéâ</div><p>–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –¥–µ–¥–ª–∞–π–Ω—ñ–≤!</p></div>';return;}
  renderDl(top,el);
}

// ‚îÄ‚îÄ FILES ‚îÄ‚îÄ
function listenFiles() {
  if(!window._db||!group.id) return;
  const {collection,query,where,orderBy,onSnapshot}=window._fb;
  const q=query(collection(window._db,'files'),where('groupId','==',group.id));
  const unsub=onSnapshot(q,snap=>{
    cachedFiles=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    renderFiles(cachedFiles);
    document.getElementById('s-files').textContent=cachedFiles.length;
  },err=>{ 
    console.warn('Files listener error:', err);
    document.getElementById('files-list').innerHTML='<div class="empty"><div class="emo">‚ö†Ô∏è</div><p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤. –ú–æ–∂–ª–∏–≤–æ, –ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω–¥–µ–∫—Å Firestore.</p></div>'; 
  });
  unsubs.push(unsub);
}
function handleFileSelect(inp) { Array.from(inp.files).forEach(uploadFile); inp.value=''; }
function handleDrop(e) { e.preventDefault(); document.getElementById('uz').classList.remove('drag'); Array.from(e.dataTransfer.files).forEach(uploadFile); }
async function uploadFile(file) {
  const MAX = 700 * 1024; // ~700KB safe Firestore limit
  if(file.size > MAX){
    alert('–§–∞–π–ª –±—ñ–ª—å—à–µ 700–ö–ë (\'' + file.name + '\'). Firestore –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≤–µ–ª–∏–∫—ñ —Ñ–∞–π–ª–∏ –Ω–∞–ø—Ä—è–º—É.\n\n–ó–∞–≤–∞–Ω—Ç–∞–∂ —Ñ–∞–π–ª –Ω–∞ Google Drive —ñ –¥–æ–¥–∞–π –ø–æ—Å–∏–ª–∞–Ω–Ω—è —á–µ—Ä–µ–∑ —Ä–æ–∑–¥—ñ–ª "–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏".');
    return;
  }
  if(!window._db){alert('Firebase –Ω–µ –≥–æ—Ç–æ–≤–∏–π');return;}
  const uz=document.getElementById('uz');
  uz.innerHTML='<div class="ui">‚è≥</div><p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ' + escHtml(file.name) + '...</p>';
  const {collection,addDoc}=window._fb;
  const reader=new FileReader();
  reader.onload=async e=>{
    try {
      await addDoc(collection(window._db,'files'),{
        groupId:group.id, groupName:group.name,
        name:file.name, size:file.size,
        uploader:userData.fullname||'–°—Ç—É–¥–µ–Ω—Ç',
        createdAt:Date.now(), dataUrl:e.target.result
      });
    } catch(err){
      console.error('Upload error:', err);
      alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + err.message);
    }
    uz.innerHTML='<div class="ui">üì§</div><p><strong>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∞–±–æ –ø–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å</strong></p><p style="font-size:10px;margin-top:2px;">–¥–æ 700–ö–ë ‚Ä¢ –±—ñ–ª—å—à—ñ —Ñ–∞–π–ª–∏ ‚Äî —á–µ—Ä–µ–∑ Google Drive —É –ú–∞—Ç–µ—Ä—ñ–∞–ª–∏</p>';
  };
  reader.readAsDataURL(file);
}
function renderFiles(files) {
  const el=document.getElementById('files-list');
  if(!files.length){el.innerHTML='<div class="empty"><div class="emo">üìÇ</div><p>–§–∞–π–ª—ñ–≤ —â–µ –Ω–µ–º–∞—î</p></div>';return;}
  el.innerHTML='<div class="file-list">'+files.map(f=>{
    const ext=(f.name||'').split('.').pop().toLowerCase();
    const ec=ext==='pdf'?'ep':['doc','docx'].includes(ext)?'ed':['xls','xlsx'].includes(ext)?'ex':'eo';
    const sz=f.size>1048576?(f.size/1048576).toFixed(1)+' –ú–ë':Math.round(f.size/1024)+' –ö–ë';
    return '<div class="file-item">'+
      '<div class="file-ext '+ec+'">'+escHtml(ext.toUpperCase())+'</div>'+
      '<div class="file-info"><div class="file-name">'+escHtml(f.name)+'</div>'+
      '<div class="file-meta">'+escHtml(f.uploader||'?')+' ‚Ä¢ '+new Date(f.createdAt).toLocaleDateString('uk-UA')+' ‚Ä¢ '+escHtml(sz)+'</div></div>'+
      '<div class="file-actions">'+
        (f.dataUrl?'<button class="btn a" onclick="dlFile(this.dataset.id)" data-id="'+escHtml(f.id)+'">‚¨á</button>':'')+
        '<button class="btn d" onclick="rmFile(this.dataset.id)" data-id="'+escHtml(f.id)+'">üóë</button>'+
      '</div></div>';
  }).join('')+'</div>';
}
async function dlFile(id) { const f=cachedFiles.find(x=>x.id===id); if(!f||!f.dataUrl)return; const a=document.createElement('a');a.href=f.dataUrl;a.download=f.name;a.click(); }
async function rmFile(id) { 
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–∞–π–ª?'))return; 
  try {
    const {doc,deleteDoc}=window._fb; 
    await deleteDoc(doc(window._db,'files',id));
  } catch(e) { alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + e.message); }
}

// ‚îÄ‚îÄ MATERIALS ‚îÄ‚îÄ
function listenMats() {
  if(!window._db||!group.id) return;
  const {collection,query,where,orderBy,onSnapshot}=window._fb;
  const q=query(collection(window._db,'materials'),where('groupId','==',group.id));
  const unsub=onSnapshot(q,snap=>{ cachedMats=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(b.createdAt||0)-(a.createdAt||0)); renderMats(cachedMats); },
  err=>{ 
    console.warn('Materials listener error:', err);
    document.getElementById('mats-list').innerHTML='<div class="empty"><div class="emo">‚ö†Ô∏è</div><p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤.</p></div>'; 
  });
  unsubs.push(unsub);
}
function filterMats(q) { renderMats(cachedMats,q.toLowerCase()); }
function renderMats(list,q='') {
  const el=document.getElementById('mats-list');
  const items=q?list.filter(m=>(m.name||'').toLowerCase().includes(q)||(m.subject||'').toLowerCase().includes(q)):list;
  if(!items.length){el.innerHTML='<div class="empty"><div class="emo">üìù</div><p>–ú–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ —â–µ –Ω–µ–º–∞—î</p></div>';return;}
  el.innerHTML='<div class="file-list">'+items.map(m=>
    '<div class="file-item">'+
    '<div class="file-ext eo">üìù</div>'+
    '<div class="file-info"><div class="file-name">'+escHtml(m.name||'')+'</div>'+
    '<div class="file-meta">'+escHtml(m.subject||'')+(m.desc?' ‚Ä¢ '+escHtml(m.desc):'')+'</div></div>'+
    '<div class="file-actions">'+
      (m.desc&&/^https?:\/\//i.test(m.desc)?'<a href="'+escHtml(m.desc)+'" target="_blank" rel="noopener noreferrer"><button class="btn a">üîó</button></a>':'')+
      '<button class="btn d" onclick="rmMat(this.dataset.id)" data-id="'+escHtml(m.id)+'">üóë</button>'+
    '</div></div>'
  ).join('')+'</div>';
}
let _groupModalMode = 'create';
let _groupEditId = null;

function groupModalAction() {
  if(_groupModalMode === 'edit' && _groupEditId) {
    _doEditGroup(_groupEditId);
  } else {
    createGroup();
  }
}

async function _doEditGroup(id) {
  const name = document.getElementById('gn').value.trim();
  const faculty = document.getElementById('gf').value.trim();
  const course = parseInt(document.getElementById('gc').value)||1;
  if(!name) return;
  const now = new Date();
  const acadYear = now.getMonth() >= 7 ? now.getFullYear() : now.getFullYear() - 1;
  const entryYear = course <= 4 ? acadYear - course + 1 : null;
  const manualCourse = course > 4 ? course : null;
  const {doc, updateDoc} = window._fb;
  await updateDoc(doc(window._db,'groups',id), {name, faculty, course, entryYear, manualCourse});
  closeModal('add-group');
  ['gn','gf','gc'].forEach(i=>document.getElementById(i).value='');
  if(window._loadGroupsForLogin) window._loadGroupsForLogin();
}

function showModal(id) { 
  if(id==='add-group') {
    _groupModalMode = 'create';
    _groupEditId = null;
    document.querySelector('#modal-add-group h3').textContent = 'üè´ –°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É–ø—É';
    document.getElementById('group-modal-btn').textContent = '–°—Ç–≤–æ—Ä–∏—Ç–∏';
  }
  document.getElementById('modal-'+id).classList.add('show'); 
}
function closeModal(id) { document.getElementById('modal-'+id).classList.remove('show'); }
async function addMat() {
  const name=document.getElementById('mn').value.trim();
  const subject=document.getElementById('ms').value.trim();
  const desc=document.getElementById('md').value.trim();
  if(!name)return;
  const {collection,addDoc}=window._fb;
  await addDoc(collection(window._db,'materials'),{groupId:group.id,groupName:group.name,name,subject,desc,uploader:userData.fullname||'?',createdAt:Date.now()});
  closeModal('add-mat');
  ['mn','ms','md'].forEach(id=>document.getElementById(id).value='');
}
async function rmMat(id) { 
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª?'))return; 
  try {
    const {doc,deleteDoc}=window._fb; 
    await deleteDoc(doc(window._db,'materials',id));
  } catch(e) { alert('–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è: ' + e.message); }
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ
function setupChatRooms() {
  const rooms=[
    {id:'group-'+group.id, label:'üë• '+group.name, sub:'–í–∞—à–∞ –≥—Ä—É–ø–∞'},
    {id:'faculty-'+(group.faculty||'general'), label:'üèõ –§–∞–∫—É–ª—å—Ç–µ—Ç', sub:group.faculty||'–ó–∞–≥–∞–ª—å–Ω–∏–π'},
    {id:'university', label:'üéì –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç', sub:'–í—Å—ñ —Å—Ç—É–¥–µ–Ω—Ç–∏'},
  ];
  const el=document.getElementById('chat-rooms');
  el.innerHTML=rooms.map(r=>
    '<div class="chat-room" onclick="openChatRoom(this.dataset.roomid,this.dataset.label)" data-roomid="'+escHtml(r.id)+'" data-label="'+escHtml(r.label)+'">'+
    escHtml(r.label)+'<div class="chat-room-sub">'+escHtml(r.sub)+'</div></div>'
  ).join('');
}
function openChatRoom(roomId, label) {
  currentChatRoom=roomId;
  document.getElementById('chat-room-title').textContent=label;
  document.querySelectorAll('.chat-room').forEach(r=>r.classList.remove('active'));
  const activeRoom=document.querySelector('[data-roomid="'+roomId+'"]');
  if(activeRoom) activeRoom.classList.add('active');
  if(chatUnsub) chatUnsub();
  const {collection,query,orderBy,onSnapshot,where,limit}=window._fb;
  const q=query(collection(window._db,'messages'),where('room','==',roomId),limit(50));
  chatUnsub=onSnapshot(q,snap=>{
    const msgs=snap.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>(a.ts||0)-(b.ts||0));
    renderMessages(msgs);
  }, err=>{
    console.warn('Chat listener error:', err);
    document.getElementById('chat-msgs').innerHTML='<div class="empty"><div class="emo">‚ö†Ô∏è</div><p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —á–∞—Ç—É</p></div>';
  });
}
function renderMessages(msgs) {
  const el=document.getElementById('chat-msgs');
  if(!msgs.length){el.innerHTML='<div class="empty"><div class="emo">üí¨</div><p>–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —â–µ –Ω–µ–º–∞—î</p></div>';return;}
  el.innerHTML=msgs.map(m=>{
    const isMe=m.uid===String(userData.userid);
    const t=m.ts?new Date(m.ts).toLocaleTimeString('uk-UA',{hour:'2-digit',minute:'2-digit'}):'';
    const canDel = canMod() || m.uid===String(userData.userid);
    return '<div class="msg '+(isMe?'me':'other')+'" style="position:relative" '+
      'onmouseenter="this.querySelector(\'.msg-del\')&&(this.querySelector(\'.msg-del\').style.opacity=1)" '+
      'onmouseleave="this.querySelector(\'.msg-del\')&&(this.querySelector(\'.msg-del\').style.opacity=0)">'+
      (!isMe?'<div class="msg-author">'+escHtml(m.author)+'</div>':'')+
      '<div style="display:flex;align-items:flex-end;gap:4px;'+(isMe?'flex-direction:row-reverse':'')+'">'+
        '<div class="msg-bubble">'+escHtml(m.text)+'</div>'+
        (canDel&&m.id?'<button class="msg-del" data-id="'+escHtml(m.id)+'" onclick="delMsg(this.dataset.id)" style="background:rgba(224,80,80,.15);border:1px solid rgba(224,80,80,.3);color:var(--accent2);border-radius:5px;padding:2px 5px;font-size:9px;cursor:pointer;opacity:0;transition:opacity .2s;flex-shrink:0">üóë</button>':'')+
      '</div>'+
      '<div class="msg-time">'+t+'</div></div>';
  }).join('');
  el.scrollTop=el.scrollHeight;
}
// escHtml defined at top of script
function chatKey(e) { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();} }
async function sendMsg() {
  if(!currentChatRoom)return;
  const inp=document.getElementById('chat-inp');
  const text=inp.value.trim();
  if(!text)return;
  inp.value='';
  const {collection,addDoc}=window._fb;
  await addDoc(collection(window._db,'messages'),{
    room:currentChatRoom, text,
    author:userData.fullname||'?',
    uid:String(userData.userid),
    groupId:group.id,
    ts:Date.now()
  });
}

async function delMsg(id) {
  if(!canMod()&&!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Å–≤–æ—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?'))return;
  try {
    const {doc,deleteDoc}=window._fb;
    await deleteDoc(doc(window._db,'messages',id));
  } catch(e){ alert('–ü–æ–º–∏–ª–∫–∞: '+e.message); }
}

// ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ
function listenAdminData() {
  if(!window._db)return;
  const {collection,query,onSnapshot,orderBy}=window._fb;
  // Groups
  onSnapshot(query(collection(window._db,'groups'),orderBy('name')),snap=>{
    const groups=snap.docs.map(d=>({id:d.id,...d.data()}));
    renderAdminGroups(groups);
  }, err=>{ console.warn('Admin groups error:',err); document.getElementById('admin-groups-list').innerHTML='<div class="empty"><p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≥—Ä—É–ø</p></div>'; });
  // Users
  onSnapshot(collection(window._db,'users'),snap=>{
    const users=snap.docs.map(d=>({id:d.id,...d.data()}));
    _allAdminUsers = users;
    const q = (document.getElementById('users-search')||{value:''}).value;
    filterAdminUsers(q);
    document.getElementById('admin-stats').innerHTML=
      '<div style="font-size:13px;line-height:2;">'+
      'üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: <b>'+users.length+'</b><br>'+
      'üè´ –ì—Ä—É–ø: <b>‚Äî</b><br>'+
      'üìÅ –§–∞–π–ª—ñ–≤: <b>‚Äî</b>'+
      '</div>';
  });
}
function renderAdminGroups(groups) {
  const el=document.getElementById('admin-groups-list');
  if(!groups.length){el.innerHTML='<div class="empty"><p>–ì—Ä—É–ø —â–µ –Ω–µ–º–∞—î</p></div>';return;}
  el.innerHTML=groups.map(g=>
    '<div class="group-item">'+
    '<div>'+
      '<div class="gname">'+escHtml(g.name)+'</div>'+
      '<div class="gcnt">'+escHtml(g.faculty||'‚Äî')+' ‚Ä¢ –ö—É—Ä—Å '+escHtml(String(getGroupCourse(g)))+(g.entryYear?' üîÑ':'')+'</div>'+
    '</div>'+
    '<div style="display:flex;gap:3px;flex-shrink:0;">'+
    '<button class="btn" onclick="editGroup(this.dataset.id,this.dataset.name,this.dataset.faculty,this.dataset.course)" data-id="'+escHtml(g.id)+'" data-name="'+escHtml(g.name)+'" data-faculty="'+escHtml(g.faculty||'')+'" data-course="'+escHtml(String(g.course||'1'))+'">‚úèÔ∏è</button>'+
    '<button class="btn d" onclick="delGroup(this.dataset.id)" data-id="'+escHtml(g.id)+'">üóë</button>'+
    '</div>'+
    '</div>'
  ).join('');
}
let _allAdminUsers = [];
function filterAdminUsers(q) {
  const filtered = q ? _allAdminUsers.filter(u => (u.name||'').toLowerCase().includes(q.toLowerCase())) : _allAdminUsers;
  renderAdminUsers(filtered);
}
function renderAdminUsers(users) {
  const el=document.getElementById('admin-users-list');
  if(!users.length){el.innerHTML='<div class="empty"><p>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —â–µ –Ω–µ–º–∞—î</p></div>';return;}
  el.innerHTML=users.map(u=>
    '<div class="user-row">'+
    '<div class="uav" style="background:'+escHtml(ROLE_COLORS[u.role]||'#8888aa')+'">'+escHtml((u.name||'?')[0].toUpperCase())+'</div>'+
    '<div style="flex:1;min-width:0;"><div class="uname" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+escHtml(u.name||'?')+'</div>'+
    '<div style="font-size:9px;color:var(--text2);">'+escHtml(u.groupName||'')+'</div></div>'+
    (canAdmin()?'<select class="role-sel" data-uid="'+escHtml(u.id)+'" onchange="setRole(this.dataset.uid,this.value)">'+
      Object.keys(ROLES).map(r=>'<option value="'+escHtml(r)+'"'+(u.role===r?' selected':'')+'>'+escHtml(ROLES[r])+'</option>').join('')+
    '</select>':'')+
    '</div>'
  ).join('');
}
async function setRole(uid, role) {
  const {doc,updateDoc}=window._fb;
  await updateDoc(doc(window._db,'users',uid),{role});
}
async function createGroup() {
  const name=document.getElementById('gn').value.trim();
  const faculty=document.getElementById('gf').value.trim();
  const course=parseInt(document.getElementById('gc').value)||1;
  if(!name)return;
  const {collection,addDoc}=window._fb;
  // For courses 1-4: calc entryYear so it auto-updates each August
  // For courses 5-6: save as manualCourse so it never auto-changes
  const now = new Date();
  const acadYear = now.getMonth() >= 7 ? now.getFullYear() : now.getFullYear() - 1;
  const entryYear = course <= 4 ? acadYear - course + 1 : null;
  const manualCourse = course > 4 ? course : null;
  await addDoc(collection(window._db,'groups'),{name,faculty,course,entryYear,manualCourse,createdAt:Date.now()});
  closeModal('add-group');
  ['gn','gf','gc'].forEach(id=>document.getElementById(id).value='');
  if(window._loadGroupsForLogin) window._loadGroupsForLogin();
}
function editGroup(id, name, faculty, course) {
  _groupModalMode = 'edit';
  _groupEditId = id;
  document.getElementById('gn').value = name;
  document.getElementById('gf').value = faculty;
  document.getElementById('gc').value = course;
  document.querySelector('#modal-add-group h3').textContent = '‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≥—Ä—É–ø—É';
  document.getElementById('group-modal-btn').textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏';
  document.getElementById('modal-add-group').classList.add('show');
}

async function delGroup(id) {
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –≥—Ä—É–ø—É? –§–∞–π–ª–∏ —Ç–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏ –∑–∞–ª–∏—à–∞—Ç—å—Å—è.'))return;
  const {doc,deleteDoc}=window._fb;
  await deleteDoc(doc(window._db,'groups',id));
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
const PAGE_TITLES={dashboard:'–ì–æ–ª–æ–≤–Ω–∞',deadlines:'–î–µ–¥–ª–∞–π–Ω–∏',courses:'–ö—É—Ä—Å–∏',files:'–§–∞–π–ª–∏',materials:'–ú–∞—Ç–µ—Ä—ñ–∞–ª–∏',chat:'–ß–∞—Ç–∏',admin:'–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å'};
function go(name) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  const labels={dashboard:'–ì–æ–ª–æ–≤',deadlines:'–î–µ–¥–ª',courses:'–ö—É—Ä—Å',files:'–§–∞–π–ª',materials:'–ú–∞—Ç–µ—Ä',chat:'–ß–∞—Ç',admin:'–ê–¥–º—ñ–Ω'};
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active',n.textContent.trim().startsWith(labels[name]||'_')));
  document.getElementById('topbar-title').textContent=PAGE_TITLES[name]||name;
  closeSidebar();
}

// ‚îÄ‚îÄ MOBILE SIDEBAR ‚îÄ‚îÄ
function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('sov').classList.add('show'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sov').classList.remove('show'); }

// ‚îÄ‚îÄ THEME ‚îÄ‚îÄ
function toggleTheme() {
  const t=document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',t);
  localStorage.setItem('sh_theme',t);
}
const st=localStorage.getItem('sh_theme');
if(st) document.documentElement.setAttribute('data-theme',st);

// ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ
function doLogout() {
  unsubs.forEach(u=>u());
  if(chatUnsub) chatUnsub();
  unsubs=[]; token=''; userData={}; allDl=[]; courses=[]; group={}; userRole='student'; cachedFiles=[]; cachedMats=[];
  localStorage.removeItem('sh_token'); localStorage.removeItem('sh_gid');
  document.getElementById('screen-app').classList.remove('active');
  document.getElementById('screen-login').classList.add('active');
}

// ‚îÄ‚îÄ AUTO LOGIN ‚îÄ‚îÄ
const sv=localStorage.getItem('sh_token'), sgid=localStorage.getItem('sh_gid');
if(sv&&sgid) {
  token=sv;
  const tryAutoLogin = async () => {
    if(!window._fb || !window._db) { setTimeout(tryAutoLogin, 300); return; }
    const {doc,getDoc}=window._fb;
    try {
      // Validate token is still working
      const testR = await fetch(MOODLE+'/webservice/rest/server.php?wstoken='+sv+'&wsfunction=core_webservice_get_site_info&moodlewsrestformat=json');
      const testD = await testR.json();
      if(testD.errorcode) { 
        localStorage.removeItem('sh_token'); localStorage.removeItem('sh_gid'); 
        return; 
      }
      const snap=await getDoc(doc(window._db,'groups',sgid));
      if(snap.exists()){group={id:sgid,...snap.data()};await initApp();}
      else {localStorage.removeItem('sh_token');localStorage.removeItem('sh_gid');}
    } catch(e){ console.warn('Auto-login error:',e); }
  };
  setTimeout(tryAutoLogin, 500);
}
</script>
</body>
</html>
